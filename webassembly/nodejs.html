<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WebAssembly on the server side - Rust By Example -- Extended Edition</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Covers popular third party Rust crates and libraries by example">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">Introduction</a></li><li class="chapter-item "><a href="../serde.html"><strong aria-hidden="true">1.</strong> Serialization</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../serde/json.html"><strong aria-hidden="true">1.1.</strong> JSON</a></li><li class="chapter-item "><a href="../serde/bincode.html"><strong aria-hidden="true">1.2.</strong> Binary</a></li><li class="chapter-item "><a href="../serde/feature.html"><strong aria-hidden="true">1.3.</strong> Third party crates</a></li></ol></li><li class="chapter-item "><a href="../rand.html"><strong aria-hidden="true">2.</strong> Random numbers</a></li><li class="chapter-item "><a href="../openssl.html"><strong aria-hidden="true">3.</strong> SSL/TLS toolkit</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../openssl/rsa.html"><strong aria-hidden="true">3.1.</strong> RSA</a></li></ol></li><li class="chapter-item "><a href="../ndarray.html"><strong aria-hidden="true">4.</strong> N-dimensional array</a></li><li class="chapter-item "><a href="../lazy_static.html"><strong aria-hidden="true">5.</strong> Lazy initialization</a></li><li class="chapter-item "><a href="../regex.html"><strong aria-hidden="true">6.</strong> Regular expression</a></li><li class="chapter-item expanded "><a href="../webassembly.html"><strong aria-hidden="true">7.</strong> WebAssembly</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../webassembly/compile.html"><strong aria-hidden="true">7.1.</strong> Compile targets</a></li><li class="chapter-item "><a href="../webassembly/run.html"><strong aria-hidden="true">7.2.</strong> Run a simple program</a></li><li class="chapter-item "><a href="../webassembly/browser.html"><strong aria-hidden="true">7.3.</strong> Rust Javascript binding</a></li><li class="chapter-item expanded "><a href="../webassembly/nodejs.html" class="active"><strong aria-hidden="true">7.4.</strong> WebAssembly on the server side</a></li><li class="chapter-item "><a href="../webassembly/nodejshelper.html"><strong aria-hidden="true">7.5.</strong> Call Javascript from Rust</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust By Example -- Extended Edition</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/second-state/rust-by-example-ext" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#rust-and-webassembly-on-the-server-side" id="rust-and-webassembly-on-the-server-side">Rust and WebAssembly on the server side</a></h1>
<p>In the previous article, we discussed how to run Rust functions in web browsers.
In this article, we will show you how to do this on the server side.
We believe that Rust and WebAssembly <a href="https://cloud.secondstate.io/server-side-webassembly/why">brings a lot of benefits</a> to server side
applications.</p>
<p>On the server side, we use the open source <a href="https://github.com/second-state/SSVM">Second State VM (SSVM)</a> to execute
Rust and WebAssembly functions in the Node.js environment. We still use
the <code>wasm-bindgen</code> crate to support binding between Rust and
Javascript. An easy way to <code>wasm-bindgen</code> in a SSVM Node.js project is to the 
<code>ssvmup</code> tool. Here is how to install <code>ssvmup</code> through the npm package manager.</p>
<pre><code>$ npm install -g ssvmup
</code></pre>
<p>In your project's <code>Cargo.toml</code>, add dependency for the <code>wasm-bindgen</code> crate.</p>
<pre><code>[dependencies]
wasm-bindgen = &quot;=0.2.61&quot;
</code></pre>
<h2><a class="header" href="#hello-world" id="hello-world">Hello world</a></h2>
<p>Below is a Rust hello world function we wrote. The function must be annotated with <code>#[wasm_bindgen]</code> in order for the Rust compiler toolchain to call <code>wasm-bindgen</code> to generate the necessary shim code that binds Rust and Javascript through WebAssembly.</p>
<pre><code>use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn say(s: String) -&gt; String {
  let r = String::from(&quot;hello &quot;);
  return r + &amp;s;
}
</code></pre>
<p>Build the <code>wasm</code> bytecode application and its Javascript helper files via <code>ssvmup</code>.
The generated files are in the <code>pkg</code> directory.</p>
<pre><code>$ ssvmup build
</code></pre>
<p>In a Javascript application, you can load the generated Javascript file, export the Rust function, and call it.</p>
<pre><code>const { say } = require('pkg/hello_lib.js');
say(&quot;Michael&quot;);
</code></pre>
<p>You can now run the Javascript application from Node.js command line.</p>
<pre><code>$ node app.js
Hello Michael
</code></pre>
<blockquote>
<p>To see the complete source code and run it in a Node.js server, <a href="https://github.com/second-state/wasm-learning/tree/master/nodejs/hello">checkout here</a>.</p>
</blockquote>
<h2><a class="header" href="#beyond-simple-arguments" id="beyond-simple-arguments">Beyond simple arguments</a></h2>
<p>Using the <code>serde</code> crate, we can pass in and return arbitary Javascript values to/from Rust functions. The idea is to serialize the entire set of call arguments, and return values, into JSON strings. First, add <code>serde</code> to your dependencies.</p>
<pre><code>[dependencies]
serde = { version = &quot;1.0&quot;, features = [&quot;derive&quot;] }
serde_json = &quot;1.0&quot;
wasm-bindgen = &quot;=0.2.61&quot;
</code></pre>
<p>The Rust function takes two floating point numbers, and returns the product of
the two. Notice that the input and return values are all encoded in JSON.</p>
<pre><code>use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn area(sides: &amp;str) -&gt; String {
  let s: (f32, f32) = serde_json::from_str(&amp;sides).unwrap();
  let a = s.0 * s.1;
  return serde_json::to_string(&amp;a).unwrap();
}
</code></pre>
<p>Build and create the <code>pkg</code> folder for the compiled <code>wasm</code> bytecode file and the Javascript shim file <code>my_project_name.js</code>.</p>
<pre><code>$ ssvmup build
</code></pre>
<p>The Javascript calling program in Node.js looks like the following.</p>
<pre><code>const { area } = require('pkg/my_project_name.js');
var x = [10., 5.];
console.log( area(JSON.stringify(x)) );
</code></pre>
<p>Run the Node.js app shows the following result.</p>
<pre><code>$ node app.js
50.0
</code></pre>
<blockquote>
<p>To see the complete source code and run it in Node.js, <a href="https://github.com/second-state/wasm-learning/tree/master/nodejs/json_io">checkout here</a>.</p>
</blockquote>
<h2><a class="header" href="#structs-and-objects" id="structs-and-objects">Structs and objects</a></h2>
<p>Using the <code>serde</code> crate, we can pass in complex Javascript objects and arrays to Rust functions, and return Javascript objects. Javascript objects are mapped to Rust structs, and arrays are mapped to Rust tuples.</p>
<p>The Rust function <code>draw()</code> takes two JSON strings, each representing a <code>Point</code> struct, and returns a JSON string representing a <code>Line</code> struct.</p>
<pre><code>use wasm_bindgen::prelude::*;
use serde::{Serialize, Deserialize};

#[derive(Serialize, Deserialize, Debug)]
struct Point {
  x: f32,
  y: f32
}

#[derive(Serialize, Deserialize, Debug)]
struct Line {
  points: Vec&lt;Point&gt;,
  valid: bool,
  length: f32,
  desc: String
}

#[wasm_bindgen]
pub fn draw(points: &amp;str) -&gt; String {
  let ps: (Point, Point, String) = serde_json::from_str(&amp;points).unwrap();
  let length = ((ps.0.x - ps.1.x) * (ps.0.x - ps.1.x) + (ps.0.y - ps.1.y) * (ps.0.y - ps.1.y)).sqrt();

  let valid = if length == 0.0 { false } else { true };
  let line = Line { points: vec![ps.0, ps.1], valid: valid, length: length, desc: ps.2 };
  return serde_json::to_string(&amp;line).unwrap();
}
</code></pre>
<p>Build and create the <code>pkg</code> folder for the compiled <code>wasm</code> bytecode file and the Javascript shim file <code>my_project_name.js</code>.</p>
<pre><code>$ ssvmup build
</code></pre>
<p>The Javascript calling program in Node.js looks like the following.</p>
<pre><code>const { draw } = require('pkg/my_project_name.js');
var x = [{x:1.5, y:3.8}, {x:2.5, y:5.8}, &quot;A thin red line&quot;];
console.log( draw(JSON.stringify(x)) );
</code></pre>
<p>Run the Node.js app shows the following result.</p>
<pre><code>$ node app.js
{&quot;points&quot;:[{&quot;x&quot;:1.5,&quot;y&quot;:3.8},{&quot;x&quot;:2.5,&quot;y&quot;:5.8}],&quot;valid&quot;:true,&quot;length&quot;:2.2360682,&quot;desc&quot;:&quot;A thin red line&quot;}
</code></pre>
<blockquote>
<p>To see the complete source code and run it in Node.js, <a href="https://github.com/second-state/wasm-learning/tree/master/nodejs/json_io">checkout here</a>.</p>
</blockquote>
<h2><a class="header" href="#binary-data" id="binary-data">Binary data</a></h2>
<p>A server side function often needs to process binary data directly. The SSVM
toolchain supports that use case out of the box.
In this example, we will show you how to create a Rust function on the server
to compute a SHA3 cryptographic digest for an arbitary input binary data array. First, add 
the <code>sh3</code> crate as a dependency.</p>
<pre><code>[dependencies]
sha3 = &quot;0.8.2&quot;
wasm-bindgen = &quot;=0.2.61&quot;
</code></pre>
<p>Below is the Rust function that computes the SHA3 digest value. Notice that both
its input and return values are byte arrays.</p>
<pre><code>use wasm_bindgen::prelude::*;
use sha3::{Digest, Sha3_256};

#[wasm_bindgen]
pub fn sha3_digest(v: &amp;[u8]) -&gt; Vec&lt;u8&gt; {
  return Sha3_256::digest(&amp;v).as_slice().to_vec();
}
</code></pre>
<p>Build and create the <code>pkg</code> folder for the compiled <code>wasm</code> bytecode file and the Javascript shim file <code>my_project_name.js</code>.</p>
<pre><code>$ ssvmup build
</code></pre>
<p>The Javascript calling program in Node.js looks like the following.</p>
<pre><code>const { sha3_digest } = require('pkg/my_project_name.js');
console.log( sha3_digest(encoder.encode(&quot;This is an important message&quot;)) );
</code></pre>
<p>Run the Node.js app shows the following result.</p>
<pre><code>$ node app.js
000000  57 1b e7 d1 bd 69 fb 31 9f 0a d3 fa 0f 9f 9a b5  W.çÑ½iû1..Óú...µ
000010  2b da 1a 8d 38 c7 19 2d 3c 0a 14 a3 36 d3 c3 cb  +Ú..8Ç.-&lt;..£6ÓÃË
</code></pre>
<blockquote>
<p>To see the complete source code and run it in Node.js, <a href="https://github.com/second-state/wasm-learning/tree/master/nodejs/functions">checkout here</a>.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../webassembly/browser.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../webassembly/nodejshelper.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../webassembly/browser.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../webassembly/nodejshelper.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-137134458-10', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        
        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
